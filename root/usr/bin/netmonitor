#!/bin/bash

# Path ke skrip utama
MAIN_SCRIPT="/www/netmonitor/vnstati_script.sh"

# File PID untuk menyimpan PID proses
PID_FILE="/var/run/netmonitor_vnstati_runner.pid"

# Fungsi untuk memulai skrip
start() {
    if [ -f "$PID_FILE" ]; then
        echo "Skrip sudah berjalan (PID: $(cat "$PID_FILE"))."
        exit 1
    fi

    # Jalankan skrip utama dalam loop setiap 5 menit
    while true; do
        bash "$MAIN_SCRIPT"
        sleep 300  # Tunggu 5 menit (300 detik)
    done &

    # Simpan PID proses ke file
    echo $! > "$PID_FILE"
    echo "Skrip berhasil dimulai (PID: $(cat "$PID_FILE"))."
}

# Fungsi untuk menghentikan skrip
stop() {
    if [ ! -f "$PID_FILE" ]; then
        echo "Skrip tidak sedang berjalan."
        exit 1
    fi

    # Hentikan proses berdasarkan PID
    PID=$(cat "$PID_FILE")
    kill "$PID" && rm "$PID_FILE"
    echo "Skrip berhasil dihentikan (PID: $PID)."
}

# Handle argumen
case "$1" in
    --start)
        start
        ;;
    --stop)
        stop
        ;;
    *)
        echo "Penggunaan: $0 {--start|--stop}"
        exit 1
        ;;
esac